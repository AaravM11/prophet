"use client"

import { useState } from "react"
import { ShieldAlert, ExternalLink, AlertTriangle, Eye, Zap, Bug, Sparkles, FlaskConical, Play, Copy } from "lucide-react"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Button } from "@/components/ui/button"
import { usePipelineStore } from "@/src/store/usePipelineStore"

const riskLevelConfig = {
  critical: {
    badge: "CRITICAL",
    textColor: "text-neon-red",
    bgColor: "bg-neon-red",
    borderColor: "border-neon-red",
    badgeBg: "bg-neon-red/15",
    badgeBorder: "border-neon-red/30",
  },
  high: {
    badge: "HIGH",
    textColor: "text-neon-red",
    bgColor: "bg-neon-red",
    borderColor: "border-neon-red",
    badgeBg: "bg-neon-red/15",
    badgeBorder: "border-neon-red/30",
  },
  medium: {
    badge: "MEDIUM",
    textColor: "text-neon-amber",
    bgColor: "bg-neon-amber",
    borderColor: "border-neon-amber",
    badgeBg: "bg-neon-amber/15",
    badgeBorder: "border-neon-amber/30",
  },
  low: {
    badge: "LOW",
    textColor: "text-neon-green",
    bgColor: "bg-neon-green",
    borderColor: "border-neon-green",
    badgeBg: "bg-neon-green/15",
    badgeBorder: "border-neon-green/30",
  },
} as const

export function VulnerabilityReport() {
  const [isGeneratingTests, setIsGeneratingTests] = useState(false)
  const [generateMessage, setGenerateMessage] = useState<{ type: "success" | "error"; text: string } | null>(null)
  const {
    vulnerabilities,
    riskScore,
    riskLevel,
    summary,
    exploitPaths,
    fixSuggestions,
    originalCode,
    contractFileName,
    generatedTestCode,
    setGeneratedTestCode,
    clearTerminalLogs,
    startFuzzing,
    isFuzzing,
  } = usePipelineStore()

  const hasData = vulnerabilities.length > 0 || riskScore !== null
  const displayRiskScore = riskScore ?? 0
  const displayRiskLevel = riskLevel ?? "low"
  const config = riskLevelConfig[displayRiskLevel]

  return (
    <section className="flex h-full flex-col gap-4 overflow-auto" aria-label="AI vulnerability report">
      {/* Risk Score Card */}
      <Card className={`${config.borderColor}/30 bg-card shadow-[0_0_20px_rgba(255,23,68,0.08)] border`}>
        <CardHeader className="pb-2">
          <div className="flex items-center justify-between">
            <CardTitle className="flex items-center gap-2 text-sm font-medium text-muted-foreground">
              <ShieldAlert className={`size-4 ${config.textColor}`} aria-hidden="true" />
              Risk Assessment
            </CardTitle>
            {riskLevel && (
              <Badge className={`${config.badgeBg} ${config.textColor} ${config.badgeBorder} border hover:${config.badgeBg}`}>
                {config.badge}
              </Badge>
            )}
          </div>
        </CardHeader>
        <CardContent>
          <div className="flex items-baseline gap-2">
            <span className={`text-5xl font-bold tracking-tight ${config.textColor}`}>
              {displayRiskScore}
            </span>
            <span className="text-lg text-muted-foreground">/100</span>
          </div>
          <div className="mt-3 h-2 overflow-hidden rounded-full bg-secondary">
            <div
              className={`h-full rounded-full ${config.bgColor} transition-all`}
              style={{ width: `${displayRiskScore}%` }}
              role="progressbar"
              aria-valuenow={displayRiskScore}
              aria-valuemin={0}
              aria-valuemax={100}
              aria-label={`Risk score ${displayRiskScore} out of 100`}
            />
          </div>
          <p className={`mt-2 text-xs ${config.textColor}/70 font-medium`}>
            {summary || (hasData ? "Analysis complete" : "No analysis yet")}
          </p>
          {hasData && (
            <div className="mt-3 space-y-2">
              <div className="flex flex-wrap gap-2">
                <Button
                  size="sm"
                  variant="outline"
                  className="border-neon-amber/50 text-neon-amber hover:bg-neon-amber/10"
                  disabled={isGeneratingTests || !originalCode.trim()}
                  onClick={async () => {
                    setGenerateMessage(null)
                    setIsGeneratingTests(true)
                    const agentUrl = process.env.NEXT_PUBLIC_AGENT_URL ?? "http://localhost:3001"
                    try {
                      const contractName = contractFileName.replace(/\.sol$/i, "") || "Contract"
                      const res = await fetch(`${agentUrl}/generate-attack`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                          source: originalCode,
                          report: {
                            contract_name: contractName,
                            vulnerabilities,
                            exploit_paths: exploitPaths,
                            fix_suggestions: fixSuggestions,
                            risk_score: (riskScore ?? 0) / 100,
                            risk_level: riskLevel ?? "low",
                            summary: summary ?? "",
                            source_hash: "",
                            meta: { generated_at: "", generator: "", inference_backend: "local", version: "" },
                          },
                        }),
                      })
                      if (!res.ok) {
                        const errText = await res.text()
                        throw new Error(errText || `${res.status} ${res.statusText}`)
                      }
                      const { testCode } = (await res.json()) as { testCode: string }
                      setGeneratedTestCode(testCode)
                      setGenerateMessage({
                        type: "success",
                        text: "Attack tests generated. Click “Run in Foundry” to execute.",
                      })
                    } catch (e) {
                      const msg =
                        (e as Error).message === "Failed to fetch"
                          ? "Agent not reachable. Start it with: npm run dev (from repo root or agent/)"
                          : (e as Error).message
                      setGenerateMessage({ type: "error", text: msg })
                      setGeneratedTestCode(null)
                      console.error("Generate attack tests failed:", e)
                    } finally {
                      setIsGeneratingTests(false)
                    }
                  }}
                >
                  <FlaskConical className="size-3.5 mr-1.5" aria-hidden="true" />
                  {isGeneratingTests ? "Generating…" : "Generate attack tests"}
                </Button>
                <Button
                  size="sm"
                  variant="outline"
                  className="border-neon-green/50 text-neon-green hover:bg-neon-green/10"
                  disabled={isFuzzing || !generatedTestCode?.trim()}
                  onClick={() => {
                    clearTerminalLogs()
                    startFuzzing()
                  }}
                >
                  <Play className="size-3.5 mr-1.5" aria-hidden="true" />
                  Run in Foundry
                </Button>
              </div>
              {generateMessage && (
                <p
                  className={
                    generateMessage.type === "error"
                      ? "text-xs text-neon-red"
                      : "text-xs text-neon-green"
                  }
                  role="status"
                >
                  {generateMessage.text}
                </p>
              )}
              {generatedTestCode?.trim() && (
                <div className="mt-2 rounded-lg border border-border bg-secondary/30 overflow-hidden">
                  <div className="flex items-center justify-between border-b border-border bg-secondary/50 px-2 py-1.5">
                    <span className="text-[10px] font-mono uppercase text-muted-foreground">
                      Generated test (Foundry)
                    </span>
                    <Button
                      variant="ghost"
                      size="sm"
                      className="h-6 text-xs"
                      onClick={async () => {
                        try {
                          await navigator.clipboard.writeText(generatedTestCode)
                          setGenerateMessage({ type: "success", text: "Copied to clipboard." })
                          setTimeout(() => setGenerateMessage(null), 2000)
                        } catch {
                          setGenerateMessage({ type: "error", text: "Copy failed." })
                        }
                      }}
                    >
                      <Copy className="size-3 mr-1" aria-hidden="true" />
                      Copy
                    </Button>
                  </div>
                  <pre className="p-2 text-[11px] font-mono text-foreground overflow-auto max-h-48 whitespace-pre">
                    {generatedTestCode}
                  </pre>
                </div>
              )}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Vulnerability Details */}
      <Card className="flex-1 border-border bg-card">
        <CardHeader className="pb-2">
          <CardTitle className="flex items-center gap-2 text-sm font-medium text-muted-foreground">
            <Bug className="size-4 text-neon-amber" aria-hidden="true" />
            0G AI Analysis Summary
          </CardTitle>
        </CardHeader>
        <CardContent className="flex flex-col gap-3">
          {!hasData ? (
            <div className="rounded-lg border border-border bg-secondary/30 p-4 text-center">
              <p className="text-sm text-muted-foreground">
                Upload a contract and run analysis to see vulnerabilities
              </p>
            </div>
          ) : vulnerabilities.length === 0 ? (
            <div className="rounded-lg border border-neon-green/20 bg-neon-green/5 p-4 text-center">
              <p className="text-sm text-neon-green font-medium">
                No vulnerabilities detected. Contract appears safe.
              </p>
            </div>
          ) : (
            <>
              {/* Primary Finding */}
              {vulnerabilities[0] && (
                <div className="rounded-lg border border-neon-red/20 bg-neon-red/5 p-3">
                  <div className="flex items-start gap-2">
                    <AlertTriangle className="mt-0.5 size-4 shrink-0 text-neon-red" aria-hidden="true" />
                    <div className="flex-1">
                      <h3 className="text-sm font-semibold text-foreground">{vulnerabilities[0].title}</h3>
                      <p className="mt-1 text-xs text-muted-foreground leading-relaxed">
                        {vulnerabilities[0].explanation}
                      </p>
                      {vulnerabilities[0].locations.length > 0 && (
                        <div className="mt-2 flex flex-wrap gap-2">
                          {vulnerabilities[0].locations.map((loc, idx) => (
                            <code
                              key={idx}
                              className="rounded bg-secondary px-1.5 py-0.5 text-neon-red font-mono text-[11px]"
                            >
                              {loc.file}:{loc.function} (L{loc.line_start}-{loc.line_end})
                            </code>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* Attack Vector */}
              {exploitPaths.length > 0 && exploitPaths[0] && (
                <div className="rounded-lg border border-border bg-secondary/30 p-3">
                  <div className="flex items-start gap-2">
                    <Zap className="mt-0.5 size-4 shrink-0 text-neon-amber" aria-hidden="true" />
                    <div className="flex-1">
                      <h3 className="text-sm font-semibold text-foreground">Attack Vector: {exploitPaths[0].name}</h3>
                      <p className="mt-1 text-xs text-muted-foreground leading-relaxed">
                        {exploitPaths[0].success_criteria}
                      </p>
                      {exploitPaths[0].steps.length > 0 && (
                        <ol className="mt-2 space-y-1 text-xs text-muted-foreground">
                          {exploitPaths[0].steps.map((step, idx) => (
                            <li key={idx} className="flex gap-2">
                              <span className="text-muted-foreground">{idx + 1}.</span>
                              <span>{step.action}: {step.notes}</span>
                            </li>
                          ))}
                        </ol>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* Impact Summary */}
              {vulnerabilities[0] && (
                <div className="rounded-lg border border-border bg-secondary/30 p-3">
                  <div className="flex items-start gap-2">
                    <Eye className="mt-0.5 size-4 shrink-0 text-[#00b0ff]" aria-hidden="true" />
                    <div className="flex-1">
                      <h3 className="text-sm font-semibold text-foreground">Impact Assessment</h3>
                      <div className="mt-2 grid grid-cols-2 gap-2 text-xs">
                        <div className="rounded-md bg-secondary/50 px-2.5 py-1.5">
                          <span className="text-muted-foreground">Severity</span>
                          <p className={`font-semibold ${riskLevelConfig[vulnerabilities[0].severity]?.textColor || config.textColor}`}>
                            {vulnerabilities[0].severity}
                          </p>
                        </div>
                        <div className="rounded-md bg-secondary/50 px-2.5 py-1.5">
                          <span className="text-muted-foreground">Confidence</span>
                          <p className="font-semibold text-neon-amber">
                            {(vulnerabilities[0].confidence * 100).toFixed(1)}%
                          </p>
                        </div>
                        <div className="rounded-md bg-secondary/50 px-2.5 py-1.5">
                          <span className="text-muted-foreground">Vulnerabilities</span>
                          <p className="font-semibold text-foreground">{vulnerabilities.length}</p>
                        </div>
                        <div className="rounded-md bg-secondary/50 px-2.5 py-1.5">
                          <span className="text-muted-foreground">Exploit Paths</span>
                          <p className="font-semibold text-foreground">{exploitPaths.length}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Action Button */}
              {fixSuggestions.length > 0 && (
                <Button className="mt-1 bg-neon-green/10 text-neon-green border border-neon-green/30 hover:bg-neon-green/20 hover:text-neon-green">
                  <Sparkles className="size-4" aria-hidden="true" />
                  View AI Patch ({fixSuggestions.length})
                  <ExternalLink className="ml-auto size-3.5 opacity-50" aria-hidden="true" />
                </Button>
              )}
            </>
          )}
        </CardContent>
      </Card>
    </section>
  )
}
